---
title: 手写图片懒加载
tags: JS
---

图片懒加载是我们再处理图片展示，从而提升`页面性能`的一个重要手段

懒加载，也就是说不会页面一打开就立即请求并展示，而是等待一会再去展示，那么等待多久呢，设置个固定的时间肯定是不对的，但是却能够感受到`懒`

```html
<style>
    li {
        list-style: none;
        height: 300px;
        border: 1px solid #ccc;
        padding: 50px 0;
    }
</style> 

<ul>
     <li>1</li>
     <li>2</li>
     <li>3</li>
     <li>4</li>
     <li>5</li>
</ul>

<img data-src="https://avatars.githubusercontent.com/u/20986264?v=4">

<script>
    const img = document.querySelector('img')

    setTimeout(() => {
        img.src = img.dataset.src  // 3秒后图片src设置成真实的url
    }, 3000)
</script>
```

我们发现个问题，如果用户始终不滚动页面，那图片用户是看不到的，那加载也是没有必要的，所以我们不应该设置固定

我们可以这样，设置页面的`滚动事件`，监听`图片`是否要进入到页面的`可视窗口`，当滚动到将要出现图片的位置，则设置图片的`src`。

```js
 const img = document.querySelector('img')
        
 window.onscroll = function() {
     let imgTop = img.getBoundingClientRect().top  // 图片上边框到可视窗口上边框的距离
     let viewHeight = document.documentElement.clientHeight  // 可视窗口高度

     if(imgTop <= viewHeight) {  // 将要出现到可视区域
         img.src = img.dataset.src
     }
 }
```

我们已经初步实现了，当图片要出现到可视窗口，再去加载。

优化：这里应该加一个`节流`，当图片加载完成也应该`移除`滚动事件监听

```js
const img = document.querySelector('img')
let flag = null

const delayFn = function() {
    if(flag) clearTimeout(flag)

    flag = setTimeout(() => {
        windowScrollFn()
        flag = null
    }, 200)
}

const windowScrollFn = function() {
    const imgTop = img.getBoundingClientRect().top
    const viewHeight = document.documentElement.clientHeight

    console.log(11)

    if(imgTop <= viewHeight) {
        img.src = img.dataset.src

        window.removeEventListener('scroll', delayFn)
    }
}

window.addEventListener('scroll', delayFn)
```

